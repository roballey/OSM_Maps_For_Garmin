#! /bin/sh
#
# Split single PBF file into multiple files for processing via mkgmap
#

show_help() {
  echo "Split a single PBF file into multiple files for processing via mkgmap"
  echo "Options:"
  echo "  -h  : Show this help"
  echo "  -r <REGION> : Specify the region to be split, defaults to 'oceania_nz'"
  echo "  -i <FILE> : Specify the input to be split, if not specified uses <REGION>.pbf"
  echo "  -p <POLYGON_FILE> : Specify an optional polygon file"
}

# Set the name of the region being generated
region="oceania_nz"

options=""

# Parse command line options
while getopts hi:p:r: opt; do
    case $opt in
        h)
            show_help
            exit 0
            ;;
	i)  echo "Input: ${OPTARG}"
	    input="input/${OPTARG}"
            ;;
        p)  echo "Polygon: ${OPTARG}"
	    polygon="input/${OPTARG}"
            if [ ! -f $polygon ]
	    then
		    echo "Polygon file '${polygon}' not found"
		    exit 1
	    fi
            options="${options} --polygon-file=${polygon}"
	    ;;
        r)  region=$OPTARG
            ;;
        *)
            show_help
            exit 1
            ;;
    esac
done

if [ -z ${input+x} ]; then input="input/${region}.pbf"; fi
if [ ! -f $input ]
then
        echo "Input file '${input}' not found"
        exit 1
fi

echo "Region: ${region}"
echo ""

# Setup path to working files generated by this script
osm_work_dir="work/osmsplitmaps/${region}"

# Create directory (including parent directories) if it doesnt exist
mkdir -p ${osm_work_dir}

rm -f ${osm_work_dir}/*
#echo "Command: input/${input}.pbf ${options} --output-dir=${osm_work_dir}"
java -Xmx8000m -jar tools/splitter-*/splitter.jar ${input} ${options} --output-dir=${osm_work_dir} > logs/split.log
